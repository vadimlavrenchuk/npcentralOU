#!/usr/bin/env node

/**
 * üîí Pre-commit hook –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —É—Ç–µ—á–∫–∏ —Å–µ–∫—Ä–µ—Ç–æ–≤
 * –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Å–µ staged —Ñ–∞–π–ª—ã –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º
 */

const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');

// –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–µ–∫—Ä–µ—Ç–æ–≤
const SECRET_PATTERNS = [
  // MongoDB
  {
    pattern: /mongodb(\+srv)?:\/\/[^:]+:(?!\[REDACTED\]|password|your_password|example)[^@\s]{3,}@/gi,
    name: 'MongoDB Connection String —Å –ø–∞—Ä–æ–ª–µ–º',
    severity: 'CRITICAL'
  },
  // Firebase
  {
    pattern: /AIzaSy[A-Za-z0-9_-]{33}(?!.*REDACTED|.*OLD_KEY)/g,
    name: 'Firebase API Key',
    severity: 'CRITICAL'
  },
  // JWT Secrets
  {
    pattern: /JWT_SECRET\s*=\s*["'](?!your_|test_|example_)[^"'\s]{20,}["']/gi,
    name: 'JWT Secret',
    severity: 'HIGH'
  },
  // API Keys
  {
    pattern: /API_KEY\s*=\s*["'](?!your_|test_|example_)[^"'\s]{20,}["']/gi,
    name: 'API Key',
    severity: 'HIGH'
  },
  // Generic passwords
  {
    pattern: /password\s*[:=]\s*["'](?!your_|test_|example_|password|123|admin)[^"'\s]{8,}["']/gi,
    name: 'Hardcoded Password',
    severity: 'HIGH'
  },
  // Generic secrets
  {
    pattern: /secret\s*[:=]\s*["'](?!your_|test_|example_)[^"'\s]{20,}["']/gi,
    name: 'Hardcoded Secret',
    severity: 'HIGH'
  },
  // GitHub tokens
  {
    pattern: /gh[pousr]_[A-Za-z0-9_]{36,}/g,
    name: 'GitHub Token',
    severity: 'CRITICAL'
  },
  // AWS
  {
    pattern: /AKIA[0-9A-Z]{16}/g,
    name: 'AWS Access Key',
    severity: 'CRITICAL'
  }
];

// –§–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å
const IGNORED_FILES = [
  '.env.example',
  '.env.template',
  'package-lock.json',
  'yarn.lock',
  'pnpm-lock.yaml'
];

// –†–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
const CHECK_EXTENSIONS = [
  '.ts', '.tsx', '.js', '.jsx', 
  '.json', '.md', '.txt', 
  '.yml', '.yaml', '.env'
];

console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ staged —Ñ–∞–π–ª–æ–≤ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤...\n');

try {
  // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ staged —Ñ–∞–π–ª–æ–≤
  const stagedFiles = execSync('git diff --cached --name-only', { encoding: 'utf-8' })
    .split('\n')
    .filter(file => file.trim() !== '');

  if (stagedFiles.length === 0) {
    console.log('‚úÖ –ù–µ—Ç staged —Ñ–∞–π–ª–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏');
    process.exit(0);
  }

  let foundSecrets = [];
  let checkedCount = 0;

  for (const file of stagedFiles) {
    const filePath = path.resolve(file);
    
    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã (—É–¥–∞–ª–µ–Ω–Ω—ã–µ)
    if (!fs.existsSync(filePath)) continue;
    
    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º—ã–µ —Ñ–∞–π–ª—ã
    const fileName = path.basename(file);
    if (IGNORED_FILES.includes(fileName)) continue;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
    const ext = path.extname(file);
    if (!CHECK_EXTENSIONS.includes(ext)) continue;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–µ .env —Ñ–∞–π–ª (–∏—Ö –Ω–µ–ª—å–∑—è –∫–æ–º–º–∏—Ç–∏—Ç—å –≤–æ–æ–±—â–µ!)
    if (fileName === '.env') {
      foundSecrets.push({
        file,
        line: 1,
        match: '.env file',
        pattern: '.env —Ñ–∞–π–ª –ù–ï –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ Git!',
        severity: 'CRITICAL'
      });
      continue;
    }

    checkedCount++;

    // –ß–∏—Ç–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞
    const content = fs.readFileSync(filePath, 'utf-8');
    const lines = content.split('\n');

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω
    for (const { pattern, name, severity } of SECRET_PATTERNS) {
      lines.forEach((line, index) => {
        const matches = line.match(pattern);
        if (matches) {
          // Skip documentation examples
          if (line.includes('example') || line.includes('template') || 
              line.includes('YOUR_') || line.includes('–ù–û–í–´–ô_') ||
              line.includes('NEW_') || line.includes('OLD_') ||
              line.match(/mongodb\+srv:\/\/(username|user|admin):(password|–ù–û–í–´–ô|NEW|OLD|YOUR|REDACTED)/i)) {
            return;
          }
          
          matches.forEach(match => {
            foundSecrets.push({
              file,
              line: index + 1,
              match,
              pattern: name,
              severity
            });
          });
        }
      });
    }
  }

  console.log(`‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: ${checkedCount}\n`);

  if (foundSecrets.length > 0) {
    console.log('‚ùå ‚ùå ‚ùå  –ù–ê–ô–î–ï–ù–´ –°–ï–ö–†–ï–¢–´! –ö–û–ú–ú–ò–¢ –û–¢–ö–õ–û–ù–ï–ù!  ‚ùå ‚ùå ‚ùå\n');
    console.log('‚ïê'.repeat(60));
    
    foundSecrets.forEach(({ file, line, match, pattern, severity }) => {
      console.log(`\nüö® ${severity}: ${pattern}`);
      console.log(`   –§–∞–π–ª: ${file}:${line}`);
      console.log(`   –ù–∞–π–¥–µ–Ω–æ: ${match.substring(0, 50)}${match.length > 50 ? '...' : ''}`);
    });

    console.log('\n' + '‚ïê'.repeat(60));
    console.log('\nüìã –ß–¢–û –î–ï–õ–ê–¢–¨:\n');
    console.log('1. –£–¥–∞–ª–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç—ã –∏–∑ —Ñ–∞–π–ª–æ–≤');
    console.log('2. –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç–µ –∏—Ö –≤ .env —Ñ–∞–π–ª');
    console.log('3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ process.env.VARIABLE_NAME –≤ –∫–æ–¥–µ');
    console.log('4. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ .env –≤ .gitignore');
    console.log('\nüí° –î–ª—è .env —Ñ–∞–π–ª–æ–≤: —Å–æ–∑–¥–∞–π—Ç–µ .env.example —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏\n');
    
    process.exit(1);
  }

  console.log('‚úÖ –°–µ–∫—Ä–µ—Ç–æ–≤ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ! –ö–æ–º–º–∏—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω.\n');
  process.exit(0);

} catch (error) {
  console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ:', error.message);
  // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —Ä–∞–∑—Ä–µ—à–∞–µ–º –∫–æ–º–º–∏—Ç, –Ω–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º
  console.log('‚ö†Ô∏è  –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å, –Ω–æ –∫–æ–º–º–∏—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω');
  process.exit(0);
}
